function getConnection() {
	const current_url = window.location.href;
	const url_object = new URL(current_url);
  
	const protocol = url_object.protocol;
	const domain = url_object.hostname;
	const port = url_object.port;
  
	return `${protocol}//${domain}:${port}`;
}

const hostdomain = getConnection();

const signin = document.getElementById('signin');
const requiredFields = ["email", "password", "name", "userRole", "birthday"];

function subtractYears(numOfYears, date = new Date()) {
    const dateCopy = new Date(date.getTime());
  
    dateCopy.setFullYear(dateCopy.getFullYear() - numOfYears);
  
    return dateCopy.toISOString().split('T')[0];
}

signin.addEventListener("click", function(){

    let data = {}
    // attribute birthday is the current date minus 18 years
    let currentDate = new Date();
    data["birthday"] = subtractYears(18, currentDate);

    storeTextOrTriggerError("name", data, "name");
    storeEmailOrTriggerError("email", data, "email");
    storeTextOrTriggerError("password", data, "password", 6, 20);
    storeTextOrTriggerError("confirm-password", data, "confirmPassword", 6, 20);

    data["userRole"] = "USER";

    if(isKeysInDict(data, requiredFields)){
        alrtMessage.innerHTML = "Successfully filled out.";
        swapAlert("alert-success", "alert-warning");

        // conpare the password and confirm password
        if(data["password"] !== data["confirmPassword"]){
            alrtMessage.innerHTML = "Password and confirm password do not match.";
            swapAlert("alert-warning", "alert-danger");
            return;
        }

        if (isChecked("policy") !== true) {
            alrtMessage.innerHTML = "You must agree to the terms and conditions.";
            swapAlert("alert-warning", "alert-danger");
            return;
        }
        
        console.log(getConnection())

        sendRequest("POST", hostdomain + "/api/v1/registration", data)
        .then(function(response){
            console.log(response);
            if(response.message == "success"){
                alrtMessage.innerHTML = "Account created successfully.";
                swapAlert("alert-success", "alert-warning");
                window.location.href = hostdomain + "/login?email=" + data["email"];
            }
            else{
                alrtMessage.innerHTML = "Failed to register account.";
                swapAlert("alert-warning", "alert-success");
            }
        }).catch(() => {
            alrtMessage.innerHTML = "Server is not responding or you don't have any conection.";
            swapAlert("alert-warning", "alert-success");
        })


    } else {
        alrtMessage.innerHTML = "Please fill in all the required fields.";
        swapAlert("alert-warning", "alert-success");
    }

})

